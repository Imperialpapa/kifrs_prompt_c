# 작업 진행 상황 및 내일 할 일 (2025-01-13)

## 🔴 현재 문제

### 주요 이슈
**두 번째 시트 "(2-3) 퇴직자 및 DC전환자 명부" 검증이 누락되고 있음**
- 증상: 전체 행 수가 첫 번째 시트 데이터 수와 동일
- 원인: 아직 정확히 파악 안 됨

### 시도한 해결 방법
1. ✅ 디버깅 로그 추가 (시트별 규칙 개수, 시트명 매칭 상세 출력)
2. ❌ Windows cp949 인코딩 문제로 이모지 제거
3. ❌ sys.stdout 재정의가 FastAPI 엔드포인트 로딩 방해
4. ❌ /version 엔드포인트가 등록되지 않는 문제 발생

### 현재 코드 상태
- 버전: v1.2.4 (2025-01-13 01:00:00)
- 파일 수정됨:
  - `backend/main.py`: 디버깅 로그 추가, 이모지 제거, /version 엔드포인트 위치 변경
  - `backend/ai_layer.py`: 이모지 제거
- 문제: auto-reload가 제대로 작동하지 않아 /version 엔드포인트가 404 반환

---

## 📋 내일 할 일 (우선순위 순)

### 1단계: 서버 정상화 (최우선)

**작업 내용:**
```bash
# 1. 서버 완전 종료 (Ctrl+C)
# 2. Python 캐시 삭제
cd D:\dev\kihoon_\by_prompt\claude\backend
rmdir /s /q __pycache__

# 3. 서버 재시작
python main.py
```

**확인 사항:**
- [ ] `http://localhost:8000/version` 접속 시 JSON 응답 나오는지
- [ ] `http://localhost:8000/docs` 에서 `/version` 엔드포인트가 목록에 있는지
- [ ] 웹 페이지 상단에 "v1.2.4 | 빌드: 2025-01-13 01:00:00" 표시되는지

### 2단계: 두 번째 시트 검증 문제 진단

**작업 내용:**
1. A.xls, B.xlsx 파일 업로드하여 검증 실행
2. **서버 콘솔 로그를 주의깊게 확인**

**확인할 로그 섹션:**

```
[OK] Loaded X validation rules from Y sheets:
   - (2-2) 재직자 명부: X rules
   - (2-3) 퇴직자 및 DC전환자 명부: ? rules  ← 이 값 확인!

[DEBUG] Rules per sheet (from AI):
   - '(2-2) 재직자 명부': X rules
   - '(2-3) 퇴직자 및 DC전환자 명부': ? rules  ← 이 값 확인!

[DEBUG] Sheet name matching debug:
   [MATCH] or [DIFFER] 확인

[SHEET] Validating sheet: '(2-3) 퇴직자 및 DC전환자 명부'
   Rows: ?, Columns: ?
   Rules found: ?  ← 0이면 문제!
```

**진단 포인트:**
- A) 규칙 로딩 단계에서 (2-3) 시트 규칙이 몇 개 로드되었는지
- B) AI 해석 후 (2-3) 시트 규칙이 몇 개 생성되었는지
- C) 시트명 매칭이 정확한지 (바이트 단위 비교)
- D) 실제 검증 시 규칙이 몇 개 찾아졌는지

### 3단계: 원인별 해결 방법

**케이스 1: B 파일 파싱 단계에서 규칙이 누락**
```
원인: (2-3) 시트의 규칙이 "해당없음" 조건이나 빈 값으로 제외됨
해결: backend/main.py 라인 240-248 파싱 로직 수정
```

**케이스 2: AI 해석 단계에서 규칙이 생성 안 됨**
```
원인: ai_layer.py의 동적 규칙 생성 로직에서 (2-3) 시트 규칙 처리 실패
해결: backend/ai_layer.py 라인 217-286 확인 및 수정
```

**케이스 3: 시트명 매칭 실패**
```
원인: A 파일과 B 파일의 시트명이 정확히 일치하지 않음 (공백, 특수문자 등)
해결: 시트명 정규화 로직 추가 (trim, 특수문자 제거 등)
```

**케이스 4: 규칙 필터링 단계에서 누락**
```
원인: backend/main.py 라인 325에서 규칙 필터링 실패
해결: 필터링 로직 확인 및 수정
```

---

## 📁 현재 파일 상태

### B 파일 규칙 (참고용)
```
시트명: (2-3) 퇴직자 및 DC전환자 명부
규칙:
1. C열 (생년월일): 8자리 TEXT로 년월일(YYYYMMDD) 포맷, 조건: 정상
2. E열 (입사일자): 8자리 TEXT로 년월일(YYYYMMDD) 포맷, 입사일자 > 생년월일, 조건: 정상
3. I열 (사유): 1, 2, 조건: 정상
```

### 수정된 파일들
- `backend/main.py` (v1.2.4)
  - 라인 207-218: 디버깅 로그 (이모지 제거)
  - 라인 271-273: 시트별 규칙 개수 출력
  - 라인 295-317: 시트별 규칙 매칭 디버깅
  - 라인 157-175: /version 엔드포인트 (재등록)

- `backend/ai_layer.py`
  - 라인 294: 이모지 제거

---

## 🔧 내일 작업 시작 전 체크리스트

- [ ] 서버 완전 종료되어 있는지 확인
- [ ] 최신 코드가 저장되어 있는지 확인
- [ ] A.xls, B.xlsx 파일 준비되어 있는지 확인
- [ ] 브라우저 캐시 비우기 준비 (Ctrl+Shift+R)

---

## 📞 예상 해결 시나리오

### 시나리오 A (가장 가능성 높음)
**원인**: B 파일에서 (2-3) 시트 규칙이 파싱되지 않음
**증상**: 로그에서 "(2-3) 퇴직자 및 DC전환자 명부: 0 rules"
**해결**: 파싱 조건 수정 (조건이 "정상"인 경우도 포함하도록)

### 시나리오 B
**원인**: AI가 (2-3) 시트 규칙을 해석하지 못함
**증상**: 파싱은 되었으나 AI 해석 후 0개
**해결**: 동적 규칙 생성 로직 수정

### 시나리오 C
**원인**: 시트명 불일치 (눈에 보이지 않는 문자 차이)
**증상**: [DIFFER] 로그 및 바이트 값 다름
**해결**: 시트명 정규화 함수 추가

---

## 💡 추가 팁

**로그 저장하는 방법:**
```powershell
# PowerShell에서
python main.py 2>&1 | Tee-Object -FilePath log.txt
```

**빠른 테스트 방법:**
```python
# Python 인터프리터에서
import pandas as pd
df = pd.read_excel('B.xlsx', header=None)
print(df[df[1] == '(2-3) 퇴직자 및 DC전환자 명부'])
```

---

**작성일**: 2025-01-13 01:00
**다음 작업 예상 시간**: 30분 ~ 1시간
**난이도**: 중 (로그만 제대로 보면 원인 파악 가능)
